openapi: 3.0.3
info:
  title: Workflow ToDo API
  version: 0.1.0
servers:
  - url: http://localhost:8080

paths:
  /tasks:
    get:
      summary: タスクを全件取得する
      responses:
        "200":
          description: OK
          content: 
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/TaskDetail" }
    post:
      summary: タスクを作成する
      requestBody:
        required: true
        content:
          application/json: 
            schema: { $ref: "#/components/schemas/CreateTaskRequest" }
      responses:
        "201": 
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/TaskDetail" }
        "400": { $ref: "#/components/responses/Error400" }
  

  /tasks/{id}:
    get: 
      summary: タスク詳細を取得する
      parameters:
        - $ref: "#/components/parameters/TaskId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/TaskDetail" }
        "404": { $ref: "#/components/responses/Error404" }


  /tasks/{id}/send-to-waiting:
    post:
      summary: タスクを確認待ちにする
      parameters:
        - $ref: "#/components/parameters/TaskId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [waitingReason]
              properties:
                waitingReason:
                  type: string
      responses:
        "200":
          description: 確認待ちに遷移
          content:
            application/json:
              schema: 
                $ref: "#/components/schemas/TaskDetail"
        "400":
          $ref: "#/components/responses/Error400"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          $ref: "#/components/responses/Error409InvalidState"


  /tasks/{id}/suspend:
    post:
      summary:  タスクを中断する
      parameters: 
        - $ref: "#/components/parameters/TaskId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [progressNote]
              properties: 
                progressNote:
                  type: string
      responses:
        "200":
          description: 中断中に遷移
          content:
            application/json:
              schema: 
                $ref: "#/components/schemas/TaskDetail"
        "400":
          $ref: "#/components/responses/Error400"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          $ref: "#/components/responses/Error409InvalidState"

  /tasks/{id}/resume:
    post: 
      summary: 中断を解除する
      parameters: 
        - $ref: "#/components/parameters/TaskId"
      responses:
        "200":
          description: "中断を解除する"
          content:
            application/json: 
              schema: 
                $ref: "#/components/schemas/TaskDetail"
        "404": 
          $ref: "#/components/responses/Error404"
        "409": 
          $ref: "#/components/responses/Error409InvalidState"

  /tasks/{id}/approve:
    post:
      summary:  タスクを承認する
      parameters: 
        - $ref: "#/components/parameters/TaskId"
      responses:
        "200":
          description: タスクを承認、完了に遷移する
          content:
            application/json:
              schema: 
                $ref: "#/components/schemas/TaskDetail"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          description: 状態不正または子タスク未完了
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalid_state:
                  $ref: "#/components/responses/Error409InvalidState/content/application~1json/examples/invalid_state"
                children_incomplete:
                  $ref: "#/components/responses/Error409ChildrenIncomplete/content/application~1json/examples/children_incomplete"
  
  /tasks/{id}/reject:
    post:
      summary:  タスクを差し戻す
      parameters: 
        - $ref: "#/components/parameters/TaskId"
      responses:
        "200":
          description: タスクを差し戻し、NORMALに遷移する
          content:
            application/json:
              schema: 
                $ref: "#/components/schemas/TaskDetail"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          $ref: "#/components/responses/Error409InvalidState"

  /tasks/{id}/complete:
    post:
      summary:  タスクを完了する
      parameters: 
        - $ref: "#/components/parameters/TaskId"
      responses:
        "200":
          description: タスクを完了に遷移する
          content:
            application/json:
              schema: 
                $ref: "#/components/schemas/TaskDetail"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          description: 状態不正または子タスク未完了
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalid_state:
                  $ref: "#/components/responses/Error409InvalidState/content/application~1json/examples/invalid_state"
                children_incomplete:
                  $ref: "#/components/responses/Error409ChildrenIncomplete/content/application~1json/examples/children_incomplete"

                    
components:
  schemas:
    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          enum: [VALIDATION_ERROR, INVALID_STATE, CHILDREN_INCOMPLETE, NOT_FOUND]
        message: 
          type: string
        details:
          type: object
          nullable: true
          description: >
            code=VALIDATION_ERRORの場合、details.fieldsにフィールドエラー配列(name/reason)を入れる。
            code=CHILDREN_INCOMPLETE の場合、details.incompleteChildren に未完了子タスクの配列（id/title/status）を入れる。その他は省略=フィールド自体を返さない。
      examples: 
        children_incomplete:
          value: 
            code: CHILDREN_INCOMPLETE
            message: 未完了の子タスクがあります。
            details: 
              incompleteChildren:
                - id: 11111111-1111-1111-1111-111111111111
                  title: 子タスクA
                  status: NORMAL
        invalid_state:
          value: 
            code: INVALID_STATE
            message: タスク状態が不正です。

    TaskDetail:
      type: object
      required: [id, title, status, priority, createdAt, updatedAt]
      properties:
        id: { type: string }
        title: { type: string }
        status: { $ref: "#/components/schemas/TaskStatus" }
        priority: { $ref: "#/components/schemas/Priority" }
        createdAt: { type: string, format: date-time }
        updatedAt: {type: string, format: date-time }

    CreateTaskRequest:
      type: object
      required: [title]
      properties:
        title: { type: string }
        parentId: { type: string, nullable: true }
        priority:
          $ref: "#/components/schemas/Priority"
      description: priority未指定の場合はMEDとして扱う

    TaskStatus:
      type: string
      enum: [NORMAL, WAITING_REVIEW, SUSPENDED, DONE]

    Priority:
      type: string
      enum: [LOW, MED, HIGH]

  parameters:
    TaskId: 
      name: id
      in: path
      required: true
      schema:
        type: string
      description: タスクID(UUID)
    
  responses:
    Error400:
      description: バリデーションエラー
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            validation_error:
              value:
                code: VALIDATION_ERROR
                message: 入力値が不正です。
                details: 
                  fields:
                    - name: title
                      reason: 空入力は禁止。

    Error404:
      description: 指定されたリソースが存在しない
      content: 
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            not_found:
              value:
                code: NOT_FOUND
                message: タスクが見つかりません。
                details: null
    
    Error409InvalidState:
      description: 状態不正
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            invalid_state:
              value:
                code: INVALID_STATE
                message: タスク状態が不正です。
                details: null

    Error409ChildrenIncomplete:
      description: 子タスク未完了
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            children_incomplete:
              value:
                code: CHILDREN_INCOMPLETE
                message: 未完了の子タスクがあります。
                details:
                  incompleteChildren:
                    - id: 11111111-1111-1111-1111-111111111111
                      title: 子タスクA
                      status: NORMAL